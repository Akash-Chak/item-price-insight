{% extends "base.html" %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/items.css') }}">
{% endblock %}

{% block head %}
<script>
    async function runScraper() {
        const check = await fetch("/check_snapshot").then(res => res.json());
        if (check.exists) {
            const proceed = confirm("A snapshot already exists for today. Do you still want to run the scraper?");
            if (!proceed) return;
        }

        document.getElementById("loadingOverlay").style.display = "flex";

        fetch("/run_scraper", { method: "POST" })
        .then(res => res.json())
        .then(data => {
            document.getElementById("loadingOverlay").style.display = "none";
            const resultBox = document.getElementById("scrapeResult");
            resultBox.style.display = "block";

            if (data.status === "success") {
                resultBox.className = "success";
                document.getElementById("scrapeMessage").innerText = data.message;
            } else {
                resultBox.className = "error";
                document.getElementById("scrapeMessage").innerText = "Error: " + data.message;
            }
        });
    }

    // ✅ Find next available ID
    function getNextId() {
        const ids = [...document.querySelectorAll("#itemsTable tbody tr input[name='id']")]
            .map(input => parseInt(input.value) || 0);
        return ids.length > 0 ? Math.max(...ids) + 1 : 1;
    }

    // ✅ Add new row with auto ID + delete button
    function addRow() {
        const table = document.getElementById("itemsTable").getElementsByTagName("tbody")[0];
        const newRow = table.insertRow();
        const newId = getNextId();

        newRow.innerHTML = `
            <td><input type="text" name="id" value="${newId}" readonly></td>
            <td><input type="text" name="title" oninput="markModified()"></td>
            <td><input type="text" name="ecommerce_link" oninput="markModified()"></td>
            <td><button type="button" class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
        `;
        markModified();
    }

    // ✅ Delete row
    function deleteRow(btn) {
        const row = btn.closest("tr");
        row.remove();
        markModified();
    }

    function markModified() {
        document.getElementById("updateBtn").disabled = false;
    }

    // ✅ Save all rows into items.json
    async function saveItems() {
        const rows = document.querySelectorAll("#itemsTable tbody tr");
        let items = [];

        rows.forEach(row => {
            const id = row.querySelector('input[name="id"]').value.trim();
            const title = row.querySelector('input[name="title"]').value.trim();
            const link = row.querySelector('input[name="ecommerce_link"]').value.trim();

            if (id && title && link) { // Only save non-empty rows
                items.push({ id, title, ecommerce_link: link });
            }
        });

        const res = await fetch("/update_items", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(items)
        });

        const data = await res.json();
        const resultBox = document.getElementById("scrapeResult");
        resultBox.style.display = "block";

        if (data.status === "success") {
            resultBox.className = "success";
            document.getElementById("scrapeMessage").innerText = "Items updated successfully!";
            document.getElementById("updateBtn").disabled = true;
        } else {
            resultBox.className = "error";
            document.getElementById("scrapeMessage").innerText = "Error updating items: " + data.message;
        }
    }
</script>
{% endblock %}

{% block content %}
<h1 style="text-align:center;">Manage Items</h1>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <p>Scraping in progress...</p>
</div>

<div id="scrapeResult"><p id="scrapeMessage"></p></div>

<div style="max-height:400px; overflow-y:auto;">
    <form id="itemsForm">
        <table id="itemsTable" border="1" style="width:100%; border-collapse:collapse;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Item URL</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td><input type="text" name="id" value="{{ item.id }}" readonly></td>
                    <td><input type="text" name="title" value="{{ item.title }}" oninput="markModified()"></td>
                    <td><input type="text" name="ecommerce_link" value="{{ item.ecommerce_link }}" oninput="markModified()"></td>
                    <td><button type="button" class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
</div>

<div class="actions">
    <button class="add-btn" onclick="addRow()" type="button">Add Row</button>
    <button id="updateBtn" class="update-btn" onclick="saveItems()" disabled type="button">Update Items Data</button>
    <button class="scrape-btn" onclick="runScraper()" type="button">Scrape Items</button>
</div>
{% endblock %}
